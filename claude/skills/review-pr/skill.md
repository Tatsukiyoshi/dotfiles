---
name: review-pr
description: GitHub PRをレビューし、日本語でレビューコメントをPRに登録する。PR番号を引数に取る。
user-invokable: true
argument-hint: "[pr-number]"
---

# PRレビューワークフロー

GitHub PR **#$ARGUMENTS** をレビューする。全ての出力・コメントは**日本語**で行うこと。

## 1. PR情報の取得

以下のコマンドを並行して実行し、PRの全体像を把握する:

```bash
gh pr view $ARGUMENTS
gh pr diff $ARGUMENTS
```

## 2. コード分析

差分を分析し、以下の観点でレビューする:

- **コードの正確性**: ロジックのバグ、エッジケースの見落とし
- **プロジェクト規約の遵守**: 既存のコードパターン・命名規則との一貫性
- **パフォーマンス**: 不要な再レンダリング、N+1クエリなどの問題
- **テストカバレッジ**: テストの充実度、重要なケースの網羅
- **セキュリティ**: XSS、インジェクション、認証・認可の問題
- **アクセシビリティ**: ARIA属性、キーボード操作対応

必要に応じて、差分に含まれるファイルの周辺コードも読み、変更のコンテキストを理解すること。

## 3. レビューコメントの登録

分析結果を以下のフォーマットで `gh pr review` を使ってPRに登録する:

```bash
gh pr review $ARGUMENTS --comment --body "<レビュー内容>"
```

### レビューコメントのフォーマット

```markdown
## コードレビュー: <PRタイトル>

### 良い点

- 良い点を箇条書きで記載

### 指摘事項

#### 1. 指摘タイトル（重要度）

重要度は以下のいずれか:

- **必須**: マージ前に修正が必要
- **推奨**: 修正が望ましいがブロッキングではない
- **軽微**: 改善提案、好みの範囲

具体的な説明と、可能であれば改善案のコードを記載する。

### まとめ

全体的な評価と、マージ可否の判定を記載する。
```

## 4. 指摘事項のIssue化

指摘事項がある場合、各指摘を課題一覧のSub-Issueとして登録する。

### Issue作成の基準

- **必須** / **推奨** / **軽微** 問わず、指摘事項は全てIssue化する
- 「確認事項」として記載した観点（将来の改善余地）も対象

### Issue作成手順

1. 指摘事項ごとに Issue 本文をファイルに書き出し、`gh issue create --body-file` でIssueを作成して、発行されたIssue番号を取得する:

```bash
cat > /tmp/issue-body.md << 'EOF'
<背景・現状・対応方針・関連PRへの言及を含む本文>
EOF

ISSUE_URL=$(gh issue create \
  --title "<指摘の種別プレフィックス>: <指摘タイトル>" \
  --label "<ラベル>" \
  --body-file /tmp/issue-body.md)
ISSUE_NUMBER=$(echo "$ISSUE_URL" | awk -F'/' '{print $NF}')
rm /tmp/issue-body.md
```

> **注意 (コマンド選択)**:
> - `awk -F'/' '{print $NF}'` は POSIX 準拠で macOS・Linux・Windows 全環境で動作する。
> - `grep -oP` は GNU grep 専用のため **macOS（BSD grep）および Windows では動作しない**。
>
> **注意**: `--body` にコードブロック（バッククォート）を含む本文を直接渡すとシェルに解釈されてエラーになるため、必ず `--body-file` を使うこと。

**タイトルプレフィックスとラベルの対応:**

| プレフィックス | 用途             | `improvement` ラベル                                   |
| -------------- | ---------------- | ------------------------------------------------------ |
| `fix:`         | バグ・不正な動作 | 付与しない                                             |
| `refactor:`    | コード品質改善   | **付与する**                                           |
| `test:`        | テスト品質改善   | **付与する**                                           |
| `perf:`        | パフォーマンス   | 軽微な最適化は**付与する**、重大な性能問題は付与しない |
| `docs:`        | ドキュメント改善 | **付与する**                                           |
| `feat:`        | 新機能・機能追加 | 判断による（UX改善等は**付与する**）                   |

> **判断基準**: 「動作の正確性・信頼性・セキュリティに影響しない」改善であれば `improvement` を付与する。
> バグ修正・セキュリティ対策・入力検証の追加など、動作に直結するものは付与しない。

**本文に含めるべき内容:**

- **背景**: どのPRレビューで発見したか（例: `PR #200 のレビューで発見`）
- **現状**: 問題のあるコードスニペット
- **対応方針**: 修正の方向性
- **関連**: PR番号と課題管理Issue（課題を一覧として管理するIssue）

2. 作成したIssueを課題を一覧として管理するIssueのSub-Issueとして紐付ける:

Sub-Issueの登録には Issue の**データベースID**（大きな数値）が必要。

> **注意 (コマンド選択)**:
> - `gh api -F key=value` は値を文字列として送るため、整数型が要求されるフィールドに使うと 422 エラーになる（全プラットフォーム共通）。
> - `printf '{"key": %d}' VALUE | gh api --input -` で整数 JSON を送ること。

例）

```bash
REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
ISSUE_DB_ID=$(gh api repos/$REPO/issues/$ISSUE_NUMBER --jq '.id')
printf '{"sub_issue_id": %d}' "$ISSUE_DB_ID" | gh api \
  --method POST \
  repos/$REPO/issues/80/sub_issues \
  --input -
```

3. 作成したIssueを課題管理Issueにコメントで追記する:

例）

```bash
gh issue comment 80 --body "<追加Issueの一覧表>"
```

4. **課題一覧の「現在の注力領域」セクションへの追加（必須）**

   課題一覧（Issue #2）に「現在の注力領域」セクションが存在する場合、作成した Issue が注力領域の作業（例: Vercel Blob 移行）に関連するものであれば、必ずロードマップ表に行を追加すること。

   - ステータスは依存 Issue の状態に応じて `🔄 着手可能` または `⏳ 待機中` を設定する
   - 依存関係が明確でない場合は `⏳ 待機中` とし、依存欄に暫定的な情報を記載する
   - `gh issue edit 2 --body "..."` で課題一覧を更新する

   > **注意**: 注力領域に追加せず「信頼性・正確性にかかわる項目」のみへの追加はしないこと。注力領域の作業に関連する Issue は両方のセクションに登録する。

## 5. 結果の表示

登録したレビュー内容のサマリーと、作成したIssue番号の一覧をユーザーに表示する。
